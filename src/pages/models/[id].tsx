import { GetStaticPaths, GetStaticProps } from 'next';
import Head from 'next/head';
import { ParsedUrlQuery } from 'querystring';
import React, { useCallback } from 'react';
import { DownloadButton } from '../../elements/components/download-button';
import { EditableLabel } from '../../elements/components/editable-label';
import { EditableMarkdownContainer } from '../../elements/components/editable-markdown';
import { EditableUsers } from '../../elements/components/editable-users';
import { ImageCarousel } from '../../elements/components/image-carousel';
import { PageContainer } from '../../elements/page';
import { useCurrent } from '../../lib/hooks/use-current';
import { useUsers } from '../../lib/hooks/use-users';
import { useWebApi } from '../../lib/hooks/use-web-api';
import { Model, ModelId, UserId } from '../../lib/schema';
import { fileApi } from '../../lib/server/file-data';
import { asArray, getColorMode } from '../../lib/util';

interface Params extends ParsedUrlQuery {
    id: ModelId;
}
interface Props {
    modelId: ModelId;
    modelData: Model;
}

const renderTags = (tags: string[]) => (
    <div className="flex flex-row flex-wrap gap-2">
        {tags.map((tag) => {
            return (
                <span
                    className="inline-flex items-center rounded-full bg-fade-100 px-2.5 py-0.5 text-xs font-medium text-fade-800 dark:bg-fade-800 dark:text-fade-200"
                    key={tag}
                >
                    {tag}
                </span>
            );
        })}
    </div>
);

const dummyImages = [
    {
        LR: 'https://imgsli.com/i/07b7f3f2-2d9f-4325-b0a6-824646131308.jpg',
        HR: 'https://imgsli.com/i/986ec7cc-2c3e-43de-8b56-82040abe65a3.jpg',
    },
];

export default function Page({ modelId, modelData }: Props) {
    const { webApi, editMode } = useWebApi();
    const model = useCurrent(webApi, 'model', modelId, modelData);

    const updateModelProperty = useCallback(
        <K extends keyof Model>(key: K, value: Model[K]) => {
            const newModel: Model = { ...model, [key]: value };
            webApi?.models.update([[modelId, newModel]]).catch((e) => console.error(e));
        },
        [webApi, modelId, model]
    );

    const { userData } = useUsers();

    return (
        <>
            <Head>
                <title>{`${model.name} - OpenModelDB`}</title>
                <meta
                    content="Generated by create next app"
                    name="description"
                />
                <meta
                    content="width=device-width, initial-scale=1"
                    name="viewport"
                />
                <link
                    href="/favicon.ico"
                    rel="icon"
                />
            </Head>
            <PageContainer>
                {/* Two columns */}
                <div className="grid h-full w-full grid-cols-3 gap-4 py-6">
                    {/* Left column */}
                    <div className="relative col-span-2 flex h-full flex-col gap-4">
                        <ImageCarousel images={dummyImages} />
                        <div className="relative">
                            <div>
                                <h1 className="m-0">
                                    <EditableLabel
                                        readonly={!editMode}
                                        text={modelData.name}
                                        onChange={(value) => updateModelProperty('name', value)}
                                    />
                                </h1>
                                <div className="m-0 flex w-full max-w-full flex-row gap-2">
                                    by{' '}
                                    <EditableUsers
                                        author={asArray(model.author)}
                                        readonly={!editMode}
                                        users={userData}
                                        onAdd={
                                            asArray(model.author).slice(-1)[0] === ''
                                                ? undefined
                                                : () => {
                                                      if (Array.isArray(model.author)) {
                                                          const newAuthor = [...model.author, '' as UserId];
                                                          updateModelProperty('author', newAuthor);
                                                      } else {
                                                          updateModelProperty('author', [model.author, '' as UserId]);
                                                      }
                                                  }
                                        }
                                        onChange={(changedAuthor, index) => {
                                            if (Array.isArray(model.author)) {
                                                const newAuthor = [...model.author];
                                                newAuthor[index] = changedAuthor;
                                                updateModelProperty('author', newAuthor);
                                            } else {
                                                updateModelProperty('author', changedAuthor);
                                            }
                                        }}
                                        onRemove={(index) => {
                                            if (Array.isArray(model.author)) {
                                                const newAuthor = [...model.author];
                                                newAuthor.splice(index, 1);
                                                if (newAuthor.length === 1) {
                                                    updateModelProperty('author', newAuthor[0]);
                                                } else {
                                                    updateModelProperty('author', newAuthor);
                                                }
                                            }
                                        }}
                                    />
                                </div>
                            </div>
                            <div className="py-4">
                                <EditableMarkdownContainer
                                    markdown={modelData.description}
                                    readonly={!editMode}
                                    onChange={(value) => updateModelProperty('description', value)}
                                />
                            </div>
                        </div>
                    </div>
                    {/* Right column */}
                    <div className="col-span-1 w-full">
                        {/* Download Button */}
                        <div className="mb-2 flex flex-col gap-2">
                            {model.resources.flatMap((resource) => {
                                return resource.urls.map((url) => (
                                    <DownloadButton
                                        key={url}
                                        resource={resource}
                                        url={url}
                                    />
                                ));
                            })}
                        </div>

                        <div className="relative table-auto overflow-hidden rounded-lg border-fade-700">
                            <table className="w-full border-collapse overflow-hidden rounded-lg border-fade-700 text-left text-sm text-gray-500 dark:text-gray-400 ">
                                <tbody className="overflow-hidden  rounded-lg ">
                                    <tr className=" ">
                                        <th
                                            className="whitespace-nowrap bg-fade-100 px-6 py-4 font-medium text-gray-900 dark:bg-fade-800 dark:text-white"
                                            scope="row"
                                        >
                                            Architecture
                                        </th>
                                        <td className="px-6 py-4">
                                            <EditableLabel
                                                readonly={!editMode}
                                                text={model.architecture}
                                                onChange={(value) => updateModelProperty('architecture', value)}
                                            />
                                        </td>
                                    </tr>
                                    <tr className="">
                                        <th
                                            className="whitespace-nowrap bg-fade-100 px-6 py-4 font-medium text-fade-900 dark:bg-fade-800 dark:text-white"
                                            scope="row"
                                        >
                                            Scale
                                        </th>
                                        <td className="px-6 py-4 ">{model.scale}</td>
                                    </tr>
                                    {model.size && (
                                        <tr className="">
                                            <th
                                                className="whitespace-nowrap bg-fade-100 px-6 py-4 font-medium text-fade-900 dark:bg-fade-800 dark:text-white"
                                                scope="row"
                                            >
                                                Size
                                            </th>
                                            <td className="px-6 py-4">{renderTags(model.size)}</td>
                                        </tr>
                                    )}
                                    <tr className="">
                                        <th
                                            className="whitespace-nowrap bg-fade-100 px-6 py-4 font-medium text-gray-900 dark:bg-fade-800 dark:text-white"
                                            scope="row"
                                        >
                                            Tags
                                        </th>
                                        <td className="px-6 py-4">{renderTags(model.tags)}</td>
                                    </tr>
                                    <tr className="">
                                        <th
                                            className="whitespace-nowrap bg-fade-100 px-6 py-4 font-medium text-gray-900 dark:bg-fade-800 dark:text-white"
                                            scope="row"
                                        >
                                            Color Mode
                                        </th>
                                        <td className="px-6 py-4">
                                            <div className="flex flex-row flex-wrap gap-2 uppercase">
                                                {getColorMode(model.inputChannels)} â†’{' '}
                                                {getColorMode(model.outputChannels)}
                                            </div>
                                        </td>
                                    </tr>
                                    {Object.entries(model)
                                        .filter(
                                            ([key, _value]) =>
                                                ![
                                                    // Handled by other parts of page
                                                    'name',
                                                    'author',
                                                    'description',
                                                    'resources',
                                                    // Already handled manually
                                                    'architecture',
                                                    'scale',
                                                    'size',
                                                    'tags',
                                                    'inputChannels',
                                                    'outputChannels',
                                                    // This is just messed up in the data
                                                    'pretrainedModelG',
                                                ].includes(key)
                                        )
                                        .filter(([_key, value]) => !!value)
                                        .sort()
                                        .map(([key, value]) => {
                                            return (
                                                <tr
                                                    className=""
                                                    key={key}
                                                >
                                                    <th
                                                        className="whitespace-nowrap bg-fade-100 px-6 py-4 font-medium capitalize text-fade-900 dark:bg-fade-800 dark:text-white"
                                                        scope="row"
                                                    >
                                                        {key}
                                                    </th>
                                                    <td className="px-6 py-4">
                                                        {Array.isArray(value)
                                                            ? renderTags(value.map((v) => String(v)))
                                                            : value}
                                                    </td>
                                                </tr>
                                            );
                                        })}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </PageContainer>
        </>
    );
}

export const getStaticPaths: GetStaticPaths<Params> = async () => {
    const modelIds = await fileApi.models.getIds();

    return {
        paths: modelIds.map((id) => ({ params: { id } })),
        fallback: false,
    };
};

export const getStaticProps: GetStaticProps<Props, Params> = async (context) => {
    const modelId = context.params?.id;
    if (!modelId) throw new Error("Missing path param 'id'");

    const modelData = await fileApi.models.get(modelId);

    return {
        props: { modelId, modelData },
    };
};
